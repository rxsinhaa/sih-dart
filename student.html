<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Common Page - Dart Institute of Technology</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .timetable-grid { display: grid; grid-template-columns: 100px repeat(4, 1fr); grid-template-rows: 40px repeat(5, 1fr); gap: 4px; }
        .grid-header { font-weight: 600; display: flex; align-items: center; justify-content: center; background-color: #f3f4f6; border-radius: 0.375rem; padding: 0.5rem; }
        .grid-cell { 
            border-radius: 0.375rem; padding: 0.75rem; min-height: 80px; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center; background-color: #ffffff; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid transparent;
        }
        .tutorial-slot {
            background-color: #ffffff !important; 
            border: 2px solid #312e81;
            color: #1e1b4b; 
        }
        .tutorial-slot .teacher-name { color: #312e81; }
        .day-label { font-weight: 600; display: flex; align-items: center; justify-content: center; }
        .subject-name { font-weight: 600; font-size: 0.875rem; }
        .teacher-name { font-size: 0.75rem; color: #4b5563; }
        
        /* Styles for AI Chat */
        #chat-window { scroll-behavior: smooth; }
        .user-message { justify-content: flex-end; }
        .user-bubble { background-color: #4f46e5; color: white; }
        .ai-bubble { background-color: #e5e7eb; color: #1f2937; }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #9ca3af;
            border-radius: 50%; display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <svg class="h-8 w-8 text-indigo-600" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z"/> <path d="M3 12h2l2 -9l2 18l2 -9l2 9l2 -18l2 9h2" />
                    </svg>
                    <span class="font-bold text-xl text-indigo-600">Dart Institute of Technology</span>
                </div>
                <div class="flex items-center">
                    <label for="branch-select" class="text-sm font-medium text-gray-700 mr-2">Your Branch:</label>
                    <select id="branch-select" class="block border border-gray-300 rounded-md shadow-sm py-1 px-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option>ECE</option>
                        <option>CS</option>
                        <option>IT</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Student Common Page</h1>
            <p class="mt-1 text-gray-600">Your weekly schedule, announcements, and academic support all in one place.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                 <h2 class="text-xl font-bold text-gray-800 mb-4">Master Schedule</h2>
                 <div id="timetable-display-container"></div>
            </div>

            <div class="space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Notice Box</h2>
                    <div class="space-y-4 text-sm">
                        <div class="p-3 bg-yellow-100 text-yellow-800 rounded-lg">
                            <p><strong>Mid-term Exam Dates:</strong> Exams will be held from Oct 15th to Oct 22nd.</p>
                        </div>
                        <div class="p-3 bg-blue-100 text-blue-800 rounded-lg">
                            <p><strong>Tech Fest "Innovate 2025":</strong> Registrations are now open!</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg flex flex-col" style="height: 500px;">
                    <div class="p-4 border-b flex items-center space-x-3">
                         <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">AI</div>
                         <div>
                            <h2 class="text-xl font-bold text-gray-800">Dart Counsellor</h2>
                            <p class="text-xs text-gray-500">Your AI Study Assistant</p>
                         </div>
                    </div>
                    <div id="chat-window" class="flex-grow p-4 overflow-y-auto">
                        <div class="flex items-start space-x-2">
                            <div class="ai-bubble p-3 rounded-lg max-w-xs">
                                <p>Hello! I'm the Dart Counsellor. How can I help with your studies today?</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t">
                        <form id="chat-form" class="flex space-x-2">
                            <input type="text" id="chat-input" placeholder="Ask about study tips, subjects..." class="flex-grow border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                            <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">Send</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="bg-white mt-auto">
        <div class="container mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-gray-500">
            <p>&copy; 2025 Dart Institute of Technology. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // --- CONFIG OBJECT ---
        const config = { branches: ['ECE', 'CS', 'IT'], days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'], timeSlots: ['8am - 10am', '10am - 12pm', '1pm - 3pm', '3pm - 5pm'], subjectColors: { 'Elec. Eng.': 'bg-blue-100', 'Mathematics': 'bg-green-100', 'Physics': 'bg-yellow-100', 'Comp. Sci.': 'bg-purple-100' } };

        // --- ELEMENT REFERENCES ---
        const branchSelect = document.getElementById('branch-select');
        const timetableDisplayContainer = document.getElementById('timetable-display-container');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatWindow = document.getElementById('chat-window');

        // --- TIMETABLE DISPLAY LOGIC ---
        let fullSchedule = null;

        function renderTimetableForBranch(schedule, branch, container) {
            const { days, timeSlots, subjectColors } = config;
            let gridHTML = '<div class="timetable-grid">';
            gridHTML += '<div></div>';
            timeSlots.forEach(slot => { gridHTML += `<div class="grid-header text-xs md:text-sm">${slot}</div>`; });
            days.forEach(day => {
                gridHTML += `<div class="day-label text-xs md:text-sm">${day}</div>`;
                timeSlots.forEach(slot => {
                    const classInfo = schedule[day][slot][branch];
                    if (classInfo) {
                        const colorClass = subjectColors[classInfo.subject] || 'bg-gray-100';
                        const tutorialClass = classInfo.isTutorial ? 'tutorial-slot' : '';
                        const tutorialLabel = classInfo.isTutorial ? ' (Lab)' : '';
                        gridHTML += `<div class="grid-cell ${colorClass} ${tutorialClass}"><span class="subject-name">${classInfo.subject}${tutorialLabel}</span><span class="teacher-name">${classInfo.teacher}</span></div>`;
                    } else {
                        gridHTML += '<div class="grid-cell bg-gray-50">--</div>';
                    }
                });
            });
            gridHTML += '</div>';
            container.innerHTML = gridHTML;
        }

        function loadAndDisplayTimetable() {
            const savedData = localStorage.getItem('savedTimetable');
            if (savedData) {
                fullSchedule = JSON.parse(savedData);
                renderTimetableForBranch(fullSchedule, branchSelect.value, timetableDisplayContainer);
            } else {
                timetableDisplayContainer.innerHTML = `<div class="text-center text-gray-500 p-8 bg-gray-100 rounded-lg">No master schedule has been published by the admin yet.</div>`;
            }
        }

        branchSelect.addEventListener('change', () => {
            if (fullSchedule) {
                renderTimetableForBranch(fullSchedule, branchSelect.value, timetableDisplayContainer);
            }
        });

        // --- DART COUNSELLOR AI LOGIC ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput) return;
            appendMessage(userInput, 'user');
            chatInput.value = '';
            showTypingIndicator();
            getAIResponse(userInput);
        });

        function appendMessage(text, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-start space-x-2 mb-4 ${sender === 'user' ? 'user-message' : ''}`;
            
            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-lg max-w-xs ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            bubble.textContent = text;

            messageWrapper.appendChild(bubble);
            chatWindow.appendChild(messageWrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'flex items-start space-x-2 mb-4';
            indicator.innerHTML = `<div class="ai-bubble p-3 rounded-lg"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            chatWindow.appendChild(indicator);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        async function getAIResponse(input) {
            const API_KEY = 'AIzaSyCFd-bk6-thGP2J_yb82bIZmwSsly1HSsE'; // <-- Paste your valid API key here
            
            // MODIFIED: Updated the model name in the URL
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`;

            const prompt = `You are "Dart Counsellor," a friendly and empathetic AI academic assistant for the Dart Institute of Technology. Your role is to help students with their academic problems. Do not answer questions outside of academics. If asked a non-academic question, politely state that you can only help with study-related topics. Keep your answers concise, supportive, and practical. User's question: "${input}"`;

            const requestBody = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 1,
                    topP: 1,
                    maxOutputTokens: 2048,
                },
                safetySettings: [
                    { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                    { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                    { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                    { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                ],
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error Details:", errorData);
                    throw new Error(`API error! Status: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.candidates || data.candidates.length === 0) {
                     throw new Error("API returned no content. This might be due to safety settings.");
                }

                const aiText = data.candidates[0].content.parts[0].text;
                
                removeTypingIndicator();
                appendMessage(aiText, 'ai');

            } catch (error) {
                console.error("AI API Error:", error);
                removeTypingIndicator();
                appendMessage("Sorry, I'm having trouble connecting right now. Please check the API key or try again later.", 'ai');
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', loadAndDisplayTimetable);
    </script>
</body>
</html>